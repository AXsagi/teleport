timeout: 25m

options:
  machineType: E2_HIGHCPU_32
  volumes:
    - name: kubeconfig
      path: /kube
  logging: CLOUD_LOGGING_ONLY
  env: 
    - KUBECONFIG=/kube/config

steps:
  - name: gcr.io/cloud-builders/gke-deploy
    id: kube-login
    entrypoint: /bin/bash
    args:
      - -c
      - gcloud container clusters get-credentials $_TEST_CLUSTER_NAME --region=$_TEST_CLUSTER_REGION --project=$PROJECT_ID

  - name: us-docker.pkg.dev/ci-account/teleport/buildbox-root:v0.1.0
    id: kube-test
    entrypoint: /bin/bash
    env:
      - TEST_KUBE=true
    args:
      - -c
      - |
        curl -O https://dl.google.com/dl/cloudsdk/channels/rapid/downloads/google-cloud-sdk-369.0.0-linux-x86_64.tar.gz && \
        tar -zxvf google-cloud-sdk-369.0.0-linux-x86_64.tar.gz && \
        ./google-cloud-sdk/install.sh -q && \
        rm -rf ./google-cloud-sdk && \
        cat $$KUBECONFIG && \ 
        gcloud container clusters get-credentials $_TEST_CLUSTER_NAME --region=$_TEST_CLUSTER_REGION --project=$PROJECT_ID && \
        make rdpclient integration-kube
    timeout: 20m